{% extends "common/base.html" %}
{% block title %}渋谷歯科技工所 | SHIBUYA Dental Laboratory {% endblock %}

{% block extra_meta %}
<!-- ページ固有のプリロード -->
<link rel="preload" href="{{ url_for('static', filename='main/top/logo02.webp') }}" as="image" fetchpriority="high">
{% endblock %}

{% block content %}
<!-- クリティカルCSS - インライン化 -->
<style>   
.dental-header {
    display: flex;
    background-color: rgb(243, 244, 245);
    align-items: center;
    margin: 0 auto;    
    width: 100%;
    color: #7c1820;
    justify-content: center;
    min-height: 180px;
    flex-wrap: wrap;
}

.logo {
    width: 160px; /* 明示的な幅指定 */
    height: 160px; /* 明示的な高さ指定 */
    flex-shrink: 0; /* サイズ変動を防止 */   
    border-radius: 4px;
    display: flex;
    align-items: center;
    margin: 0 20px;
    justify-content: center;
    position: relative; /* 子要素の位置制御用 */
    overflow: hidden; /* はみ出し防止 */
}

.logo img {
    width: 160px; /* 明示的な幅 */
    height: 160px; /* 明示的な高さ */    
    display: block; /* インライン要素のスペースを除去 */
    /* レイアウトシフト対策の追加 */
    object-fit: contain; /* 画像の縦横比を保持 */    
    opacity: 0; /* 初期状態で透明 */
    transition: opacity 0.3s ease; /* スムーズな表示 */
}

/* 画像読み込みエラー時のスタイル */
.logo img.error {
    opacity: 0.3;
    background-color: #f0f0f0;
}

/* レスポンシブ対応時の修正 */
@media (max-width: 768px) {
    .logo {
        margin-bottom: 15px;
    }
    
    .logo img {
        margin-right: 0; /* モバイル時はマージンリセット */
        position: relative; /* モバイル時は通常の配置に戻す */
    }
}

.text-content {
    display: flex;
    flex-direction: column;
    max-width: 100%;
}

.japanese-text {
    font-weight: normal;
    font-size: 50px;
    font-family: "Shin Go", "Shin-Go", "Kozuka Gothic Pro", "Kozuka Gothic Pr6N", "KozGoPro-Medium", "Hiragino Kaku Gothic Pro", "ヒラギノ角ゴ Pro W3", "Meiryo", "メイリオ", "MS PGothic", "ＭＳ Ｐゴシック", sans-serif;
    line-height: 1.1; /* 行間を固定 */
    margin: 0; /* マージンをリセット */    
}

.english-text {
    font-size: 24px;
    line-height: 1.2; /* 行間を固定 */
    margin: 8px 0 0 0; /* 上部マージンを固定 */
}

/* 基本リンクスタイル */
a:link { color: #8b0000; text-decoration: none; }
a:visited { color: #b22222; text-decoration: none; }
a:hover { color: #b22222; text-decoration: none; }
a:active { color: #b22222; text-decoration: none; }

/* メインボックス */
.box1 {
    border: solid 1px orange;
    margin: 10px auto;   
    padding: 10px;     
}
.box1 div {
    text-align: center;
}

/* コンテナスタイル */
.mainbox00 {
    margin: 20px 0;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .japanese-text {
        font-size: 32px;
    }
    .english-text {
        font-size: 18px;
    }
}
/* セクション自体を中央に配置 */
.autotransplant-news{
  max-width: 900px;      /* お好みで */
  margin: 0 auto;        /* 画面中央へ */
}

/* 見出し＋ステータスを縦に並べて中央寄せ */
.autotransplant-news .news-header{
  display: flex;
  flex-direction: column;
  align-items: center;    /* 水平中央 */
  gap: 0px;
  text-align: center;     /* テキスト中央 */
}

/* ステータス行の中身（点・更新時刻・ボタン・スピナー）を中央寄せ */
.autotransplant-news .news-status{
  display: flex;
  align-items: center;
  justify-content: center; /* 中央揃え */
  gap: 10px;
  flex-wrap: wrap;         /* 狭い画面で折り返し */
}

/* お好みで見出しの余白を少しだけ詰める */
.autotransplant-news .news-heading{
  margin: 0;
  margin-top: 15px; 
}

.last-updated {
  font-size: 1.4em;  /* または 16px, 18px など */
  font-weight: bold;
  margin: 0;
}

</style>

<!-- メインヘッダー -->
<section class="dental-header">
    <div class="logo">
        <img src="{{ url_for('static', filename='main/top/logo.png') }}" 
        alt="渋谷歯科技工所ロゴ" 
        width="160" 
        height="160"
        loading="lazy"
        decoding="sync"
        fetchpriority="high"
        style="opacity: 0;"
        onload="this.style.opacity='1';">
    </div>
    <div class="text-content">
      <div class="japanese-text">渋谷歯科技工所</div>
      <div class="english-text">SHIBUYA Dental Laboratory</div>
    </div>
</section> 

<!-- 管理者メニュー -->
{% if current_user.is_authenticated and current_user.is_administrator %}
<ul>         
    <li class="nav-item">
    <a class="nav-link {% if request.endpoint == 'main.meziro' %}active{% endif %}" href="{{ url_for('main.meziro') }}">MEZIRO</a>
    </li>
    <li class="nav-item">
    <a class="nav-link {% if request.endpoint == 'main.ugu_box' %}active{% endif %}" href="{{ url_for('main.ugu_box') }}">UGU_BOX</a>
    </li> 
    <li class="nav-item">
    <a class="nav-link {% if request.endpoint == 'main.s3_browser' %}active{% endif %}" href="{{ url_for('main.s3_browser') }}">s3_browser</a>
    </li>  
</ul>                                    
{% endif %}

<!-- 連絡先情報 -->
<h2>〒343-0845 埼玉県越谷市南越谷4-9-6 新越谷プラザビル203</h2>
<h2><a href="tel:0489618151">Tel 048-961-8151</a></h2>
<h3>E-mail shibuya8020@gmail.com</h3>

<div class="d-flex flex-column gap-3 mb-4 mt-3 mx-auto" style="max-width: 550px; width: 100%;">
    <a href="https://line.me/ti/p/9KRzw2ndvX" target="_blank" rel="noopener noreferrer" class="btn" style="background-color: #00B900; color: white;"><b>LINEで連絡</b></a>
</div>         

<!-- データ送信リンク -->
<a href="{{ url_for('main.meziro_upload_index') }}" class="text-decoration-none">
  <div class="alert alert-primary text-center shadow-sm" style="cursor: pointer; font-size: 1.5rem; font-weight: bold;">
    データ送信はこちらをクリック。送信ページに移動します
  </div>
</a>

<h2>技工製品</h2>
<h2>補綴全般 CAD/CAM全般 ノンクラスプデンチャー バイオブロック IOS対応</h2>           

<!-- 自家歯牙移植セクション -->
<a href="{{ url_for('pages.root_replica') }}" target="_self">
    <h2>レプリカを用いた自家歯牙移植</h2>
</a>

<div class="box box1">
  <h2>
    <a href="{{ url_for('pages.root_replica') }}" target="_self">
      自家歯牙移植用レプリカ
    </a>
  </h2>

  <div>
    <img src="{{ url_for('static', filename='main/top/root_replica003.webp') }}"
         alt="歯根レプリカ003" width="300" height="225" loading="lazy" decoding="async">
    <img src="{{ url_for('static', filename='main/top/root_replica004.webp') }}"
         alt="歯根レプリカ004" width="300" height="225" loading="lazy" decoding="async">
  </div>

  <div class="autotransplant-news">
    <div class="news-header">      

      <h3 class="news-heading" style="font-size: 1.6em; font-weight: 800; letter-spacing: 0.5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); margin-bottom: 8px;">
        <a href="{{ url_for('news.autotransplant_news', kind='research', lang='ja') }}" style="color: #1e3a8a; text-decoration: none;">
          自家歯牙移植 最新News
        </a>
      </h3>

      <div class="news-status">
        <span class="pulse-dot" aria-hidden="true"></span>
        <span id="news-last-updated" class="last-updated">最終更新: 読み込み中…</span>
        <button id="news-refresh-btn" type="button" class="news-refresh-btn" aria-label="ニュースを更新">更新</button>
        <span id="news-loading" class="spinner" aria-hidden="true" hidden></span>
      </div>
    </div>

    {% if autotransplant_headlines %}
      <ul id="autotransplant-headlines" class="autotransplant-headlines text-only" aria-label="自家歯牙移植の最新ニュース">
        {% for n in autotransplant_headlines %}
        <li>
          <a href="{{ n.url }}" target="_blank" rel="noopener"
            title="{{ n.ai_summary or '' }}">
            {{ n.ai_headline or n.title }}  {# ← headline_ja を ai_headline に変更 #}
          </a>
          {% if n.published_at %}
            <small class="news-date">{{ n.published_at[:10] }}</small>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    {% else %}
      <ul id="autotransplant-headlines" class="autotransplant-headlines text-only" aria-label="自家歯牙移植の最新ニュース"></ul>
      <p class="text-muted" id="news-empty">ニュースは準備中です。</p>
    {% endif %}
    
  </div>
</div>

<style>
.autotransplant-news { margin-top: .5rem; }
.news-header { display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap; }
.news-heading { font-size: 1.05rem; font-weight: 600; margin: 0; color:#222; }
.news-status { display:flex; align-items:center; gap:.5rem; font-size:.9rem; color:#555; }
.pulse-dot {
  width:8px; height:8px; border-radius:50%; background:#2b6cb0; display:inline-block;
  box-shadow:0 0 0 0 rgba(43,108,176,0.6); animation:pulse 1.8s infinite;
}
@keyframes pulse { 0% { box-shadow:0 0 0 0 rgba(43,108,176,0.6); }
  70% { box-shadow:0 0 0 10px rgba(43,108,176,0); } 100% { box-shadow:0 0 0 0 rgba(43,108,176,0); } }
.news-refresh-btn { border:1px solid #ddd; background:#fff; padding:.25rem .5rem; border-radius:4px; cursor:pointer; }
.news-refresh-btn:hover { background:#f5f5f5; }
.spinner {
  width:14px; height:14px; border:2px solid #ddd; border-top-color:#2b6cb0; border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.autotransplant-headlines.text-only { margin:.25rem 0 0; padding-left:1rem; }
.autotransplant-headlines.text-only li { list-style:disc; margin:.25rem 0; line-height:1.35;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.autotransplant-headlines.text-only a { color:#222; text-decoration:none; }
.autotransplant-headlines.text-only a:hover { text-decoration:underline; }
.news-date { color:#888; margin-left:.5rem; font-size:.85em; }
.news-more { margin-top:.4rem; }
.news-more a { font-size:.9em; }
</style>

<script>
(function(){
  const listEl = document.getElementById('autotransplant-headlines');
  const lastUpdatedEl = document.getElementById('news-last-updated');
  const btn = document.getElementById('news-refresh-btn');
  const loading = document.getElementById('news-loading');
  const empty = document.getElementById('news-empty');

  async function fetchHeadlines() {
    try {
      loading.hidden = false;
      const res = await fetch('/news/api/latest?kind=research&lang=all&limit=5', {cache:'no-store'});
      const data = await res.json();

      // UL 更新
      listEl.innerHTML = '';
      (data.items || []).forEach(it => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = it.url; a.target = '_blank'; a.rel = 'noopener';
        a.textContent = it.title || '';
        li.appendChild(a);
        if (it.published_at) {
          const s = document.createElement('small');
          s.className = 'news-date';
          s.textContent = ' ' + it.published_at;
          li.appendChild(s);
        }
        listEl.appendChild(li);
      });

      if (empty) empty.style.display = (data.items && data.items.length) ? 'none' : '';

      // 最終更新表示（ローカル時刻に整形）
      const d = new Date(data.updated_at || Date.now());
      const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0'), mm = String(d.getMinutes()).padStart(2,'0');
      lastUpdatedEl.textContent = `最終更新: ${y}-${m}-${day} ${hh}:${mm}`;
    } catch (e) {
      lastUpdatedEl.textContent = '最終更新: 取得に失敗しました';
    } finally {
      loading.hidden = true;
    }
  }

  btn.addEventListener('click', fetchHeadlines);
  // 初回ロード
  fetchHeadlines();
  // 1時間おきに静かに更新
  setInterval(fetchHeadlines, 60 * 60 * 1000);
})();
</script>

<!-- ジルコニアセクション -->
<h2>ジルコニア</h2>
<div class="box box1">        
<h2>
    <a href="{{ url_for('pages.zirconia') }}" target="_self">
    PFZ Zirconia
    </a>
</h2>

<div class="img-wrap">      
    <a href="{{ url_for('pages.zirconia') }}" target="_self">
    <img src="{{ url_for('static', filename='main/top/002.webp') }}"
        alt="ジルコニア001"
        width="300" 
        height="300"
        loading="lazy"
        decoding="async">
    </a>

    <a href="{{ url_for('pages.zirconia') }}" target="_self">
    <img src="{{ url_for('static', filename='main/top/003.webp') }}"
        alt="ジルコニア002"
        width="300" 
        height="300"
        loading="lazy"
        decoding="async">
    </a>
</div>
</div>

<!-- 非クリティカルCSS - 遅延読み込み -->
<style>
  /* ファーストビュー外のスタイル */
  h1 {
     margin: 0 0 8px;
     font-size: 1.8rem;
     font-weight: 700;
   }
   .lead {
     margin: 0 0 24px;
     color: #555;
   }

   .grid {
     display: grid;
     grid-template-columns: 1fr;
     gap: 1rem;
   }
   @media (min-width: 880px) {
     .grid {
       grid-template-columns: 1.2fr 1fr;
     }
   }

   section {
     background: #fafafa;
     border: 1px solid #eee;
     border-radius: 10px;
     padding: 16px;
   }
   section h2 {
     margin: 0 0 12px;
     font-size: 1.2rem;
   }

   .video {
     position: relative;
     width: 500px;
     aspect-ratio: 16/9;
     background: #000;
     border-radius: 8px;
     overflow: hidden;
     margin: 8px auto 20px;
     cursor: pointer;
   }
   .video iframe {
     position: absolute;
     inset: 0;
     width: 100%;
     height: 100%;
     border: 0;
   }

   .link-list {
     list-style: none;
     padding: 0;
     margin: 0 0 8px;
   }
   .link-list li {
     margin: 8px 0;
   }
   .link-list a {
     text-decoration: none;
     color: #0a58ca;
   }
   .link-list a:hover {
     text-decoration: underline;
   }

   .card {
     display: block;
     border: 1px solid #e5e5e5;
     border-radius: 10px;
     overflow: hidden;
     text-decoration: none;
     color: inherit;
     background: #fff;
     transition: box-shadow .15s ease-in-out, transform .06s ease-in-out;
   }
   .card:hover {
     box-shadow: 0 6px 18px rgba(0,0,0,.08);
     transform: translateY(-1px);
   }
   .card img {
     display: block;
     width: 100%;
     height: auto;
   }
   .card .card-body {
     padding: 10px 12px;
     font-size: .95rem;
   }

   .thumb-grid {
   display: flex;
   flex-wrap: wrap;
   gap: 1rem;
   align-items: flex-start;
 }
 .thumb-grid .card{
   width: auto;
   display: inline-block;
 }
 .thumb-grid .card img{
   width: auto;
   height: auto;
   max-width: none !important;
 }

 @media (max-width: 576px){
   .thumb-grid .card img{
     max-width: 100% !important;
     height: auto;
   }
 }         
        
        .video-thumbnail {
            position: relative;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .play-button {
            width: 80px;
            height: 80px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .play-button:hover {
            background: rgba(255, 0, 0, 0.8);
            transform: scale(1.1);
        }
        
        .play-button::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 20px solid white;
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
            margin-left: 4px;
        }       
        
        .video-title {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white;
            padding: 20px 15px 10px;
            font-size: 14px;
            font-weight: bold;
        }

        /* レスポンシブ対応 */
        @media (max-width: 576px) {
            .video {
                width: 100%;
                max-width: 400px;
            }
        }
</style>

<!-- メインコンテンツエリア -->
<div class="mainbox00">  
  <div class="container">
    <header>
      <h1>index</h1>
      <p class="lead">歯科技工士の仕事や実験・製作手順の資料です。</p>
    </header>

    <div class="grid">
      <!-- 左カラム：テキスト＋動画＋手順リンク -->
      <section>
          <h2>歯科技工士の仕事</h2> 

    <!-- 動画1: 歯科技工士の仕事 -->
    <div class="video" onclick="loadVideo('video1', '8Ca6YuMNXyQ')">
        <div id="video1" class="video-thumbnail" style="background-image: url('https://img.youtube.com/vi/8Ca6YuMNXyQ/hqdefault.jpg');">
            <div class="play-button"></div>
            <div class="video-title">歯科技工士の仕事</div>
        </div>
    </div>

    <h2>石膏の注ぎ方</h2>
    
    <!-- 動画2: 石膏の注ぎ方 -->
    <div class="video" onclick="loadVideo('video2', '4r6pxVJDpZs')">
        <div id="video2" class="video-thumbnail" style="background-image: url('https://img.youtube.com/vi/4r6pxVJDpZs/hqdefault.jpg');">
            <div class="play-button"></div>
            <div class="video-title">石膏の注ぎ方</div>
        </div>
    </div>
    

        <h2>技工物の製作手順</h2>
        <ul class="link-list">
          <li><a href="shibuya/mokei001.html" target="_self">模型作り</a></li>
          <li><a href="shibuya/mokei002.html" target="_self">ワックスアップ、埋没</a></li>
          <li><a href="shibuya/mokei.cast.html" target="_self">鋳造</a></li>
          <li><a href="shibuya/mokei.kennma.html" target="_self">調整・研磨</a></li>
          <li><a href="shibuya/tekigo.html" target="_self">臨床模型上での適合</a></li>
        </ul>
      </section>

      <!-- 右カラム：サムネイルリンク -->
      <section aria-labelledby="exp-title">
        <h2 id="exp-title">実験・資料</h2>
        <div class="thumb-grid">
          <a class="card" href="shibuya/cadcamcore.html" target="_self" aria-label="CADCAMメタルコア">
            <img src="{{ url_for('static', filename='pages/index/cadcamcore.jpg') }}" alt="CADCAMメタルコア" loading="lazy">
            <div class="card-body">CADCAMメタルコア</div>
          </a>

          <a class="card" href="shibuya/cadcam.html" target="_self" aria-label="CADCAM冠破壊実験">
            <img src="{{ url_for('static', filename='pages/index/cadcam.jpg') }}" alt="CADCAM冠破壊実験" loading="lazy">
            <div class="card-body">CADCAM冠破壊実験</div>
          </a>

          <a class="card" href="shibuya/primer.html" target="_self" aria-label="プライマー実験">
            <img src="{{ url_for('static', filename='pages/index/primer.jpg') }}" alt="プライマー実験" loading="lazy">
            <div class="card-body">プライマー実験</div>
          </a>

          <a class="card" href="shibuya/shitubako.html" target="_self" aria-label="湿箱実験">
            <img src="{{ url_for('static', filename='pages/index/shitubako.jpg') }}" alt="湿箱実験" loading="lazy">
            <div class="card-body">湿箱実験</div>
          </a>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- ブログセクション -->
<div class="container my-3">
    <div class="row mb-2">
        <!-- コンテンツ -->
        <div class="col-md-8">
            <!-- ブログ投稿 -->
            <section id="blog_post">
                <div class="row">
                    {# ここを blog_posts ではなく top_blog_posts にする #}
                    {% for post in top_blog_posts %}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                              {% if post.featured_video %}
                              <!-- 動画がある場合：サムネ画像＋再生アイコン -->
                              <div class="mb-3" style="text-align: center; position: relative;">
                                  <a href="{{ url_for('main.blog_post', blog_post_id=post.post_id) }}"
                                    style="display: inline-block; position: relative;">
                                      {% if post.featured_thumbnail %}
                                          <img src="{{ url_for('static', filename='featured_image/' + post.featured_thumbnail) }}"
                                              class="img-fluid"
                                              width="250"
                                              height="250"
                                              style="object-fit: cover;"
                                              loading="lazy"
                                              decoding="async"
                                              alt="{{ post.summary }}">
                                      {% else %}
                                          {# サムネがまだ無い場合のフォールバック（今の黒背景のままでもOK） #}
                                          <div style="background-color: #000; width: 250px; height: 250px;
                                                      display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                                              <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="white" viewBox="0 0 16 16">
                                                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                                  <path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445z"/>
                                              </svg>
                                          </div>
                                      {% endif %}

                                      <!-- 再生アイコンを中央にオーバーレイ -->
                                      <div style="position: absolute; top: 50%; left: 50%;
                                                  transform: translate(-50%, -50%);">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="white" viewBox="0 0 16 16">
                                              <path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445z"/>
                                          </svg>
                                      </div>

                                      <!-- 「動画」ラベル -->
                                      <div style="position: absolute; bottom: 10px; right: 10px;
                                                  background: rgba(0,0,0,0.7); color: white;
                                                  padding: 5px 10px; border-radius: 3px;">
                                          動画
                                      </div>
                                  </a>
                              </div>
                          {% elif post.featured_image %}
                              <!-- 画像のみの場合 -->
                              <div class="mb-3" style="text-align: center;">
                                  <img src="{{ url_for('static', filename='featured_image/' + post.featured_image) }}"
                                      class="img-fluid"
                                      width="250"
                                      height="250"
                                      style="object-fit: scale-down;"
                                      loading="lazy"
                                      decoding="async"
                                      alt="{{ post.summary }}">
                              </div>
                          {% endif %}

                                <h3>
                                    <a href="{{ url_for('main.blog_post', blog_post_id=post.post_id) }}"
                                       class="card-title text-decoration-none">
                                        <span class="fst-italic">
                                            {{ post.title or post.summary | truncate(14) }}
                                        </span>
                                    </a>
                                </h3>

                                <p>
                                    {{ post.date[:10] if post.date }}
                                    by: {{ post.author_name or 'Unknown' }}
                                </p>

                                <p class="card-text">{{ post.summary | truncate(40) }}</p>

                                <a href="{{ url_for('main.blog_post', blog_post_id=post.post_id) }}"
                                   class="btn btn-light">
                                    続きを読む…
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>
        
        <!-- サイドバー -->
        <div class="col-md-4">
            <div class="position-sticky" style="top: 2rem;">
                <!-- 検索欄 -->
                <div class="container-fluid mb-3">
                    <form action="{{ url_for('main.search') }}" class="d-flex" method="POST">
                        {{ form.hidden_tag() }}
                        {{ render_field(form.searchtext, class="form-control me-2", placeholder="検索するテキストを入力") }}
                        {{ form.submit(class="btn btn-outline-success") }}
                    </form>
                </div>
                
                <!-- 会社情報 -->
                <div class="p-4 mb-2 bg-light">
                    <h4 class="fst-italic">サイト情報</h4>
                    <p>当サイトは現在テスト運用中です。</p>
                </div>
                
                <!-- 最新記事 -->
                <div class="p-4">
                    <h4 class="fst-italic">RECENT POST <span class="ms-2 fs-6">最新記事</span></h4>
                    <hr>
                    <ol class="list-unstyled">
                        {% for recent_post in recent_blog_posts %}
                        <li>
                            <a href="{{ url_for('main.blog_post', blog_post_id=recent_post.post_id) }}" class="text-decoration-none">
                                {% if recent_post.featured_image and recent_post.featured_image != "none" %}
                                    <img src="{{ url_for('static', filename='featured_image/' + recent_post.featured_image) }}"
                                        class="img-fluid" width="90" height="50">
                                {% endif %}
                                <span class="ms-2">{{ recent_post.title | truncate(14) }}</span>
                            </a>
                        </li>
                        <hr>
                        {% endfor %}
                    </ol>
                </div>
                
                <!-- カテゴリ一覧 -->
                <div class="p-4">
                    <h4 class="fst-italic">CATEGORY <span class="ms-2 fs-6">カテゴリ一覧</span></h4>
                    <hr>
                    <ol class="list-unstyled">
                        {% for blog_category in blog_categories %}
                        <li>
                            <a href="{{ url_for('main.category_posts', blog_category_id=blog_category.id) }}" class="text-decoration-none">
                                <span class="ms-2">{{ blog_category.category | truncate(20) }}</span>
                            </a>
                        </li>
                        <hr>
                        {% endfor %}
                    </ol>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ページネーション -->
    <div class="row mb-2">
        <nav class="my-2" aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if not blog_posts.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{% if blog_posts.has_prev %}{{ url_for('main.index', page=blog_posts.prev_num) }}{% else %}#{% endif %}">前へ</a>
                </li>

                {% for page_num in range(1, blog_posts.pages + 1) %}
                    {% if page_num == blog_posts.page %}
                        <li class="page-item active"><a class="page-link" href="#">{{ page_num }}</a></li>
                    {% elif page_num == 1 or page_num == blog_posts.pages or (page_num >= blog_posts.page - 2 and page_num <= blog_posts.page + 2) %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('main.index', page=page_num) }}">{{ page_num }}</a></li>
                    {% elif page_num == blog_posts.page - 3 or page_num == blog_posts.page + 3 %}
                        <li class="page-item disabled"><a class="page-link" href="#">&hellip;</a></li>
                    {% endif %}
                {% endfor %}

                <li class="page-item {% if not blog_posts.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{% if blog_posts.has_next %}{{ url_for('main.index', page=blog_posts.next_num) }}{% else %}#{% endif %}">次へ</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- YouTube動画の遅延読み込み用JavaScript -->
<script>
function loadVideo(elementId, videoId) {
    const element = document.getElementById(elementId);
    const iframe = document.createElement('iframe');
    iframe.src = `https://www.youtube.com/embed/${videoId}`;
    iframe.title = 'YouTube video player';
    iframe.allow = 'accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; web-share';
    iframe.allowFullscreen = true;
    iframe.style.cssText = 'position: absolute; inset: 0; width: 100%; height: 100%; border: 0;';
    
    element.innerHTML = '';
    element.appendChild(iframe);
}

// 画像の読み込み完了を確実に検知
document.addEventListener('DOMContentLoaded', function() {
    const logoImg = document.querySelector('.logo img');
    if (logoImg && logoImg.complete && logoImg.naturalHeight !== 0) {
        logoImg.style.opacity = '1';
    }
});
</script>
<script>
(function(){
  const listEl = document.getElementById('autotransplant-headlines');
  const lastUpdatedEl = document.getElementById('news-last-updated');
  const btn = document.getElementById('news-refresh-btn');
  const loading = document.getElementById('news-loading');
  const empty = document.getElementById('news-empty');

  async function fetchHeadlines() {
    try {
      loading.hidden = false;
      
      // 複数の種類を取得してマージ
      const kinds = ['research', 'news', 'case'];
      const allItems = [];
      
      for (const kind of kinds) {
        const res = await fetch(`/news/api/latest?kind=${kind}&lang=ja&limit=10`, {cache:'no-store'});
        const data = await res.json();
        allItems.push(...(data.items || []));
      }
      
      // 日付順にソート
      allItems.sort((a, b) => (b.published_at || '').localeCompare(a.published_at || ''));
      
      // 重複排除
      const seen = new Set();
      const uniqueItems = [];
      for (const item of allItems) {
        if (!seen.has(item.url)) {
          seen.add(item.url);
          uniqueItems.push(item);
          if (uniqueItems.length >= 5) break;
        }
      }

      // UL 更新
      listEl.innerHTML = '';
      uniqueItems.forEach(it => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = it.url;
        a.target = '_blank';
        a.rel = 'noopener';
        
        // ai_headline を優先、なければ title
        a.textContent = it.ai_headline || it.title || '';
        
        // ツールチップにサマリーを設定
        if (it.ai_summary) {
          a.title = it.ai_summary;
        }
        
        li.appendChild(a);
        
        if (it.published_at) {
          const s = document.createElement('small');
          s.className = 'news-date';
          s.textContent = ' ' + it.published_at;
          li.appendChild(s);
        }
        listEl.appendChild(li);
      });

      if (empty) empty.style.display = uniqueItems.length ? 'none' : '';

      // 最終更新表示（ローカル時刻に整形）
      const d = new Date();
      const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0'), mm = String(d.getMinutes()).padStart(2,'0');
      lastUpdatedEl.textContent = `最終更新: ${y}-${m}-${day} ${hh}:${mm}`;
    } catch (e) {
      console.error('Failed to fetch headlines:', e);
      lastUpdatedEl.textContent = '最終更新: 取得に失敗しました';
    } finally {
      loading.hidden = true;
    }
  }

  btn.addEventListener('click', fetchHeadlines);
  // 初回ロード
  fetchHeadlines();
  // 1時間おきに静かに更新
  setInterval(fetchHeadlines, 60 * 60 * 1000);
})();
</script>

{% endblock %}