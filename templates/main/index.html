{% extends "common/base.html" %}
{% block title %}渋谷歯科技工所 | SHIBUYA Dental Laboratory {% endblock %}

{% block extra_meta %}
<!-- ページ固有のプリロード -->
<link rel="preload" href="{{ url_for('static', filename='main/top/logo02.webp') }}" as="image" fetchpriority="high">
{% endblock %}

{% block content %}
<!-- クリティカルCSS - インライン化 -->
<style>   
.dental-header {
    display: flex;
    background-color: rgb(243, 244, 245);
    align-items: center;
    margin: 0 auto;
    padding: 20px;
    width: 100%;
    color: #7c1820;
    justify-content: center;
    min-height: 197px; /* ロゴ画像 + パディング分の高さを事前確保 */
}

.logo {
    width: 157px; /* 明示的な幅指定 */
    height: 157px; /* 明示的な高さ指定 */
    flex-shrink: 0; /* サイズ変動を防止 */
    /* レイアウトシフト対策の追加 */
    background-color: rgba(124, 24, 32, 0.05); /* 薄い背景色でプレースホルダー */
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative; /* 子要素の位置制御用 */
    overflow: hidden; /* はみ出し防止 */
}

.logo img {
    width: 157px; /* 明示的な幅 */
    height: 157px; /* 明示的な高さ */
    margin-right: 20px;
    display: block; /* インライン要素のスペースを除去 */
    /* レイアウトシフト対策の追加 */
    object-fit: contain; /* 画像の縦横比を保持 */    
    opacity: 0; /* 初期状態で透明 */
    transition: opacity 0.3s ease; /* スムーズな表示 */
}

.logo img.loaded {
    opacity: 1; /* 読み込み完了後に表示 */
}

/* 画像読み込みエラー時のスタイル */
.logo img.error {
    opacity: 0.3;
    background-color: #f0f0f0;
}

/* レスポンシブ対応時の修正 */
@media (max-width: 768px) {
    .logo {
        margin-bottom: 15px;
    }
    
    .logo img {
        margin-right: 0; /* モバイル時はマージンリセット */
        position: relative; /* モバイル時は通常の配置に戻す */
    }
}

.text-content {
    display: flex;
    flex-direction: column;
}

.japanese-text {
    font-weight: normal;
    font-size: 50px;
    font-family: "Shin Go", "Shin-Go", "Kozuka Gothic Pro", "Kozuka Gothic Pr6N", "KozGoPro-Medium", "Hiragino Kaku Gothic Pro", "ヒラギノ角ゴ Pro W3", "Meiryo", "メイリオ", "MS PGothic", "ＭＳ Ｐゴシック", sans-serif;
}

.english-text {
    font-size: 24px;
}

/* 基本リンクスタイル */
a:link { color: #8b0000; text-decoration: none; }
a:visited { color: #b22222; text-decoration: none; }
a:hover { color: #b22222; text-decoration: none; }
a:active { color: #b22222; text-decoration: none; }

/* メインボックス */
.box1 {
    border: solid 1px orange;
    margin: 10px auto;   
    padding: 10px;     
}
.box1 div {
    text-align: center;
}

/* コンテナスタイル */
.mainbox00 {
    margin: 20px 0;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .japanese-text {
        font-size: 32px;
    }
    .english-text {
        font-size: 18px;
    }
}
</style>

<!-- メインヘッダー -->
<section class="dental-header">
    <div class="logo">
        <img src="{{ url_for('static', filename='main/top/logo02.webp') }}" 
        alt="渋谷歯科技工所ロゴ" 
        width="157" 
        height="157"
        loading="eager"
        decoding="sync"
        fetchpriority="high"
        style="opacity: 0;"
        onload="this.style.opacity='1';">
    </div>
    <div class="text-content">
      <div class="japanese-text">渋谷歯科技工所</div>
      <div class="english-text">SHIBUYA Dental Laboratory</div>
    </div>
</section> 

<!-- 管理者メニュー -->
{% if current_user.is_authenticated and current_user.is_administrator %}
<ul>         
    <li class="nav-item">
    <a class="nav-link {% if request.endpoint == 'main.meziro' %}active{% endif %}" href="{{ url_for('main.meziro') }}">MEZIRO</a>
    </li>
    <li class="nav-item">
    <a class="nav-link {% if request.endpoint == 'main.ugu_box' %}active{% endif %}" href="{{ url_for('main.ugu_box') }}">UGU_BOX</a>
    </li> 
    <li class="nav-item">
    <a class="nav-link {% if request.endpoint == 'main.s3_browser' %}active{% endif %}" href="{{ url_for('main.s3_browser') }}">s3_browser</a>
    </li>  
</ul>                                    
{% endif %}

<!-- 連絡先情報 -->
<h2>〒343-0845 埼玉県越谷市南越谷4-9-6 新越谷プラザビル203</h2>
<h2><a href="tel:0489618151">Tel 048-961-8151</a></h2>
<h3>E-mail shibuya8020@gmail.com</h3>

<div class="d-flex flex-column gap-3 mb-4 mt-3 mx-auto" style="max-width: 550px; width: 100%;">
    <a href="https://line.me/ti/p/9KRzw2ndvX" target="_blank" rel="noopener noreferrer" class="btn" style="background-color: #00B900; color: white;"><b>LINEで連絡</b></a>
</div>         

<!-- データ送信リンク -->
<a href="{{ url_for('main.meziro_upload_index') }}" class="text-decoration-none">
  <div class="alert alert-primary text-center shadow-sm" style="cursor: pointer; font-size: 1.5rem; font-weight: bold;">
    データ送信はこちらをクリックしてください！送信ページに移動します
  </div>
</a>

<h2>技工製品</h2>
<h2>補綴全般 CAD/CAM全般 ノンクラスプデンチャー バイオブロック IOS対応</h2>           

<!-- 自家歯牙移植セクション -->
<a href="{{ url_for('pages.root_replica') }}" target="_self">
    <h2>レプリカを用いた自家歯牙移植</h2>
</a>

<div class="box box1">        
    <a href="{{ url_for('pages.root_replica') }}" target="_self">
        <h2>自家歯牙移植用レプリカ</h2>                   
        <div>      
            <img src="{{ url_for('static', filename='main/top/root_replica003.webp') }}"
            alt="歯根レプリカ003"
            width="300" 
            height="225"
            loading="lazy"
            decoding="async">

            <img src="{{ url_for('static', filename='main/top/root_replica004.webp') }}"
            alt="歯根レプリカ004"
            width="300" 
            height="225"
            loading="eager"
            decoding="async">
        </div>
    </a>
</div>

<!-- ジルコニアセクション -->
<h2>ジルコニア</h2>
<div class="box box1">        
<h2>
    <a href="{{ url_for('pages.zirconia') }}" target="_self">
    PFZ Zirconia
    </a>
</h2>

<div class="img-wrap">      
    <a href="{{ url_for('pages.zirconia') }}" target="_self">
    <img src="{{ url_for('static', filename='main/top/002.webp') }}"
        alt="ジルコニア001"
        width="300" 
        height="300"
        loading="lazy"
        decoding="async">
    </a>

    <a href="{{ url_for('pages.zirconia') }}" target="_self">
    <img src="{{ url_for('static', filename='main/top/003.webp') }}"
        alt="ジルコニア002"
        width="300" 
        height="300"
        loading="lazy"
        decoding="async">
    </a>
</div>
</div>

<!-- 非クリティカルCSS - 遅延読み込み -->
<style>
  /* ファーストビュー外のスタイル */
  h1 {
     margin: 0 0 8px;
     font-size: 1.8rem;
     font-weight: 700;
   }
   .lead {
     margin: 0 0 24px;
     color: #555;
   }

   .grid {
     display: grid;
     grid-template-columns: 1fr;
     gap: 1rem;
   }
   @media (min-width: 880px) {
     .grid {
       grid-template-columns: 1.2fr 1fr;
     }
   }

   section {
     background: #fafafa;
     border: 1px solid #eee;
     border-radius: 10px;
     padding: 16px;
   }
   section h2 {
     margin: 0 0 12px;
     font-size: 1.2rem;
   }

   .video {
     position: relative;
     width: 500px;
     aspect-ratio: 16/9;
     background: #000;
     border-radius: 8px;
     overflow: hidden;
     margin: 8px auto 20px;
     cursor: pointer;
   }
   .video iframe {
     position: absolute;
     inset: 0;
     width: 100%;
     height: 100%;
     border: 0;
   }

   .link-list {
     list-style: none;
     padding: 0;
     margin: 0 0 8px;
   }
   .link-list li {
     margin: 8px 0;
   }
   .link-list a {
     text-decoration: none;
     color: #0a58ca;
   }
   .link-list a:hover {
     text-decoration: underline;
   }

   .card {
     display: block;
     border: 1px solid #e5e5e5;
     border-radius: 10px;
     overflow: hidden;
     text-decoration: none;
     color: inherit;
     background: #fff;
     transition: box-shadow .15s ease-in-out, transform .06s ease-in-out;
   }
   .card:hover {
     box-shadow: 0 6px 18px rgba(0,0,0,.08);
     transform: translateY(-1px);
   }
   .card img {
     display: block;
     width: 100%;
     height: auto;
   }
   .card .card-body {
     padding: 10px 12px;
     font-size: .95rem;
   }

   .thumb-grid {
   display: flex;
   flex-wrap: wrap;
   gap: 1rem;
   align-items: flex-start;
 }
 .thumb-grid .card{
   width: auto;
   display: inline-block;
 }
 .thumb-grid .card img{
   width: auto;
   height: auto;
   max-width: none !important;
 }

 @media (max-width: 576px){
   .thumb-grid .card img{
     max-width: 100% !important;
     height: auto;
   }
 }         
        
        .video-thumbnail {
            position: relative;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .play-button {
            width: 80px;
            height: 80px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .play-button:hover {
            background: rgba(255, 0, 0, 0.8);
            transform: scale(1.1);
        }
        
        .play-button::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 20px solid white;
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
            margin-left: 4px;
        }       
        
        .video-title {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white;
            padding: 20px 15px 10px;
            font-size: 14px;
            font-weight: bold;
        }

        /* レスポンシブ対応 */
        @media (max-width: 576px) {
            .video {
                width: 100%;
                max-width: 400px;
            }
        }
</style>

<!-- メインコンテンツエリア -->
<div class="mainbox00">  
  <div class="container">
    <header>
      <h1>index</h1>
      <p class="lead">歯科技工士の仕事や実験・製作手順の資料です。</p>
    </header>

    <div class="grid">
      <!-- 左カラム：テキスト＋動画＋手順リンク -->
      <section>
          <h2>歯科技工士の仕事</h2> 

    <!-- 動画1: 歯科技工士の仕事 -->
    <div class="video" onclick="loadVideo('video1', '8Ca6YuMNXyQ')">
        <div id="video1" class="video-thumbnail" style="background-image: url('https://img.youtube.com/vi/8Ca6YuMNXyQ/hqdefault.jpg');">
            <div class="play-button"></div>
            <div class="video-title">歯科技工士の仕事</div>
        </div>
    </div>

    <h2>石膏の注ぎ方</h2>
    
    <!-- 動画2: 石膏の注ぎ方 -->
    <div class="video" onclick="loadVideo('video2', '4r6pxVJDpZs')">
        <div id="video2" class="video-thumbnail" style="background-image: url('https://img.youtube.com/vi/4r6pxVJDpZs/hqdefault.jpg');">
            <div class="play-button"></div>
            <div class="video-title">石膏の注ぎ方</div>
        </div>
    </div>
    

        <h2>技工物の製作手順</h2>
        <ul class="link-list">
          <li><a href="shibuya/mokei001.html" target="_self">模型作り</a></li>
          <li><a href="shibuya/mokei002.html" target="_self">ワックスアップ、埋没</a></li>
          <li><a href="shibuya/mokei.cast.html" target="_self">鋳造</a></li>
          <li><a href="shibuya/mokei.kennma.html" target="_self">調整・研磨</a></li>
          <li><a href="shibuya/tekigo.html" target="_self">臨床模型上での適合</a></li>
        </ul>
      </section>

      <!-- 右カラム：サムネイルリンク -->
      <section aria-labelledby="exp-title">
        <h2 id="exp-title">実験・資料</h2>
        <div class="thumb-grid">
          <a class="card" href="shibuya/cadcamcore.html" target="_self" aria-label="CADCAMメタルコア">
            <img src="{{ url_for('static', filename='pages/index/cadcamcore.jpg') }}" alt="CADCAMメタルコア" loading="lazy">
            <div class="card-body">CADCAMメタルコア</div>
          </a>

          <a class="card" href="shibuya/cadcam.html" target="_self" aria-label="CADCAM冠破壊実験">
            <img src="{{ url_for('static', filename='pages/index/cadcam.jpg') }}" alt="CADCAM冠破壊実験" loading="lazy">
            <div class="card-body">CADCAM冠破壊実験</div>
          </a>

          <a class="card" href="shibuya/primer.html" target="_self" aria-label="プライマー実験">
            <img src="{{ url_for('static', filename='pages/index/primer.jpg') }}" alt="プライマー実験" loading="lazy">
            <div class="card-body">プライマー実験</div>
          </a>

          <a class="card" href="shibuya/shitubako.html" target="_self" aria-label="湿箱実験">
            <img src="{{ url_for('static', filename='pages/index/shitubako.jpg') }}" alt="湿箱実験" loading="lazy">
            <div class="card-body">湿箱実験</div>
          </a>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- ブログセクション -->
<div class="container my-3">
    <div class="row mb-2">
        <!-- コンテンツ -->
        <div class="col-md-8">
            <!-- ブログ投稿 -->
            <section id="blog_post">
                <div class="row">
                    {% for post in blog_posts.items %}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                {% if post.featured_image %}
                                <div class="mb-3" style="text-align: center;">
                                    <img src="{{ url_for('static', filename='featured_image/' + post.featured_image) }}"
                                    class="img-fluid"
                                    width="250"
                                    height="250"
                                    style="object-fit: scale-down;"
                                    loading="lazy"
                                    decoding="async"
                                    alt="{{ post.title }}">
                                </div>
                                {% endif %}
                                <h3>
                                    <a href="{{ url_for('main.blog_post', blog_post_id=post.id) }}" class="card-title text-decoration-none">
                                        <span class="fst-italic">{{ post.title | truncate(14) }}</span>
                                    </a>
                                </h3>
                                <p>{{ post.date.strftime('%Y-%m-%d') }} by: {{ post.author.username | truncate(10) }}</p>
                                <p class="card-text">{{ post.summary | truncate(40) }}</p>
                                <a href="{{ url_for('main.blog_post', blog_post_id=post.id) }}" class="btn btn-Light">続きを読む…</a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>
        
        <!-- サイドバー -->
        <div class="col-md-4">
            <div class="position-sticky" style="top: 2rem;">
                <!-- 検索欄 -->
                <div class="container-fluid mb-3">
                    <form action="{{ url_for('main.search') }}" class="d-flex" method="POST">
                        {{ form.hidden_tag() }}
                        {{ render_field(form.searchtext, class="form-control me-2", placeholder="検索するテキストを入力") }}
                        {{ form.submit(class="btn btn-outline-success") }}
                    </form>
                </div>
                
                <!-- 会社情報 -->
                <div class="p-4 mb-2 bg-light">
                    <h4 class="fst-italic">サイト情報</h4>
                    <p>当サイトは現在テスト運用中です。</p>
                </div>
                
                <!-- 最新記事 -->
                <div class="p-4">
                    <h4 class="fst-italic">RECENT POST <span class="ms-2 fs-6">最新記事</span></h4>
                    <hr>
                    <ol class="list-unstyled">
                        {% for recent_post in recent_blog_posts %}
                        <li>
                            <a href="{{ url_for('main.blog_post', blog_post_id=recent_post.id) }}" class="text-decoration-none">
                                {% if recent_post.featured_image %}
                                <img src="{{ url_for('static', filename='featured_image/' + recent_post.featured_image) }}" 
                                     class="img-fluid" 
                                     width="90" 
                                     height="50"
                                     loading="lazy"
                                     alt="{{ recent_post.title }}">
                                {% endif %}
                                <span class="ms-2">{{ recent_post.title | truncate(14) }}</span>
                            </a>
                        </li>
                        <hr>
                        {% endfor %}
                    </ol>
                </div>
                
                <!-- カテゴリ一覧 -->
                <div class="p-4">
                    <h4 class="fst-italic">CATEGORY <span class="ms-2 fs-6">カテゴリ一覧</span></h4>
                    <hr>
                    <ol class="list-unstyled">
                        {% for blog_category in blog_categories %}
                        <li>
                            <a href="{{ url_for('main.category_posts', blog_category_id=blog_category.id) }}" class="text-decoration-none">
                                <span class="ms-2">{{ blog_category.category | truncate(20) }}</span>
                            </a>
                        </li>
                        <hr>
                        {% endfor %}
                    </ol>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ページネーション -->
    <div class="row mb-2">
        <nav class="my-2" aria-label="Page navigation">
            <ul class="pagination justify-content-center">
              <li {% if blog_posts.has_prev %}class="page-item"{% else %} class="page-item disabled"{% endif %}><a class="page-link" href="{% if blog_posts.has_prev %}{{ url_for('main.index', page=blog_posts.prev_num) }}{% else %}#{% endif %}">前へ</a></li>
    
              {% for page_num in blog_posts.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}  
                {% if page_num %}
                    {% if blog_posts.page == page_num %}
                        <li class="page-item disabled"><a class="page-link" href="#">{{ page_num }}</a></li>
                    {% else %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('main.index', page=page_num) }}">{{ page_num }}</a></li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled"><a class="page-link" href="#">&hellip;</a></li>
                {% endif %}
              {% endfor %}
    
              <li {% if blog_posts.has_next %}class="page-item"{% else %} class="page-item disabled"{% endif %}><a class="page-link" href="{% if blog_posts.has_next %}{{ url_for('main.index', page=blog_posts.next_num) }}{% else %}#{% endif %}">次へ</a></li>
            </ul>
        </nav>
    </div>
</div>

<!-- YouTube動画の遅延読み込み用JavaScript -->
<script>
function loadVideo(elementId, videoId) {
    const element = document.getElementById(elementId);
    const iframe = document.createElement('iframe');
    iframe.src = `https://www.youtube.com/embed/${videoId}`;
    iframe.title = 'YouTube video player';
    iframe.allow = 'accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; web-share';
    iframe.allowFullscreen = true;
    iframe.style.cssText = 'position: absolute; inset: 0; width: 100%; height: 100%; border: 0;';
    
    element.innerHTML = '';
    element.appendChild(iframe);
}

// 画像の読み込み完了を確実に検知
document.addEventListener('DOMContentLoaded', function() {
    const logoImg = document.querySelector('.logo img');
    if (logoImg && logoImg.complete && logoImg.naturalHeight !== 0) {
        logoImg.style.opacity = '1';
    }
});
</script>

{% endblock %}