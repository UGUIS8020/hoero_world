
{% extends "common/base.html" %}

{# SEO最適化 #}
{% block title %}自家歯牙移植Q&A｜よくある質問と専門回答｜渋谷歯科技工所{% endblock %}
{% block description %}自家歯牙移植に関するよくある質問と専門的な回答を掲載。治療法、成功率、費用、インプラントとの比較など、患者様と歯科医師の疑問にお答えします。{% endblock %}
{% block keywords %}自家歯牙移植,Q&A,よくある質問,治療法,成功率,費用,インプラント比較,歯科治療,埼玉県,越谷市,渋谷歯科技工所{% endblock %}

{% block og_type %}article{% endblock %}
{% block og_description %}自家歯牙移植のQ&A集。治療法、成功率、費用について専門的にお答えします。{% endblock %}
{% block og_url %}https://shibuya8020.com/pages/root_replica_qa{% endblock %}

{% block extra_meta %}
  {# Twitter Card 固有設定 #}
  <meta name="twitter:title" content="自家歯牙移植Q&A｜専門回答集">
  <meta name="twitter:description" content="自家歯牙移植の疑問に専門的にお答えします。治療法・成功率・費用など詳しく解説。">

  {# パンくず構造化データ #}
  <script type="application/ld+json">
  {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
          {
              "@type": "ListItem",
              "position": 1,
              "name": "ホーム",
              "item": "https://shibuya8020.com/"
          },
          {
              "@type": "ListItem",
              "position": 2,
              "name": "自家歯牙移植Q&A",
              "item": "https://shibuya8020.com/pages/root_replica_qa"
          }
      ]
  }
  </script>

  {# FAQ構造化データ #}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "name": "自家歯牙移植Q&A",
    "description": "自家歯牙移植に関するよくある質問と専門的な回答集",
    "url": "https://shibuya8020.com/pages/root_replica_qa",
    "author": {
      "@type": "Organization",
      "name": "渋谷歯科技工所",
      "url": "https://shibuya8020.com/"
    },
    "publisher": {
      "@type": "Organization",
      "name": "渋谷歯科技工所",
      "logo": {
        "@type": "ImageObject",
        "url": "https://shibuya8020.com/images/logo02.jpg"
      }
    },
    "mainEntity": [
      {
        "@type": "Question",
        "name": "自家歯牙移植の成功率はどのくらいですか？",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "適切な条件下では90%以上の成功率を示します。ドナー歯の状態、移植部位の骨量、患者様の全身状態などが成功に影響します。"
        }
      },
      {
        "@type": "Question",
        "name": "インプラントと比較したメリットは？",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "自分の歯を使用するため生体親和性が高く、歯根膜が保持されるため自然な感覚が得られます。また、長期的な予後が良好とされています。"
        }
      }
    ]
  }
  </script>

  {# 医療免責事項 #}
  <meta name="medical-disclaimer" content="本サイトの情報は一般的な参考情報であり、医学的アドバイスではありません。具体的な治療については必ず歯科医師にご相談ください。">
{% endblock %}

{% block content %}

<style>
    .faq-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 0 15px;
    }
    

    
    .qa-section {
        margin-bottom: 40px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .qa-header {
        background-color: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .qa-item {
        padding: 25px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .qa-item:last-child {
        border-bottom: none;
    }
    
    .qa-question {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 15px;
        padding-left: 25px;
        position: relative;
    }
    
    .qa-question:before {
        content: "Q";
        position: absolute;
        left: 0;
        top: 0;
        background-color: #007bff;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        font-size: 12px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .qa-answer {
        padding-left: 25px;
        position: relative;
        line-height: 1.7;
        color: #495057;
    }
    
    .qa-answer:before {
        content: "A";
        position: absolute;
        left: 0;
        top: 0;
        background-color: #28a745;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        font-size: 12px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }
    
    .comparison-table th,
    .comparison-table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
    }
    
    .comparison-table th {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    
    .latest-qa-section {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 25px;
        margin-top: 40px;
    }
    
    .latest-qa-item {
        background-color: white;
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .qa-date {
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 10px;
    }
    
    .raiden-link {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 20px;
        margin: 30px 0;
        border-radius: 0 8px 8px 0;
    }
    
    .search-box {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    
    .qa-input-container {
        position: relative;
    }
    
    .qa-input {
        width: 100%;
        padding: 15px;
        border: 2px solid #007bff;
        border-radius: 8px;
        font-size: 16px;
        resize: vertical;
        min-height: 80px;
    }
    
    .qa-input:focus {
        outline: none;
        border-color: #0056b3;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .raiden-response {
        background-color: white;
        border: 2px solid #28a745;
        border-radius: 8px;
        padding: 20px;
        margin-top: 15px;
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .response-header {
        font-weight: bold;
        color: #28a745;
        margin-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
    }
    
    .response-content {
        line-height: 1.7;
        color: #495057;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .tag-container {
        margin-top: 15px;
    }
    
    .tag {
        display: inline-block;
        background-color: #6c757d;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        margin-right: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    
    .tag:hover {
        background-color: #495057;
    }
    
    .tag-treatment { background-color: #007bff; }
    .tag-cost { background-color: #28a745; }
    .tag-risk { background-color: #dc3545; }
    .tag-procedure { background-color: #ffc107; color: #212529; }
</style>

    <nav class="breadcrumb-nav" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">ホーム</a></li>
            <li class="breadcrumb-item active" aria-current="page">自家歯牙移植Q&A</li>
        </ol>
    </nav>


<div class="faq-container"> 
    

    <!-- ページヘッダー -->
    <div class="text-center mb-3">
        <h1>自家歯牙移植Q&A</h1>
        <p class="lead">よくある質問と専門的な回答</p>
        <p>自家歯牙移植に関する歯科医療従事者,専門家からの質問にお答えします</p>
    </div>

    <!-- AI質問ボックス -->
    <div class="search-box">
        <h3>raidenに直接質問する</h3>
        <p class="mb-3">自家歯牙移植専門AI「raiden」がお答えします</p>
        <div class="qa-input-container">
            <textarea class="qa-input" placeholder="質問を入力してください（例：「歯髄腔閉塞（PCO）の発生メカニズムを詳しく教えてください」「根未完成歯移植における再血管化の過程について説明してください」）" id="raiden-question" rows="3"></textarea>
            <button class="btn btn-primary mt-2" id="ask-raiden">raidenに質問する</button>
        </div>
        <div id="raiden-response" class="raiden-response" style="display: none;">
            <div class="response-header">
                <strong>raidenの回答:</strong>
                <button class="btn btn-sm btn-outline-secondary float-end" id="save-qa">この回答をQ&Aに追加</button>
            </div>
            <div class="response-content" id="response-text"></div>
        </div>
        <div class="tag-container">
            <p class="small text-muted">よくある質問例：</p>
            <span class="tag tag-treatment" data-question="自家歯牙移植とインプラントはどちらが良いですか？">治療法比較</span>
            <span class="tag tag-cost" data-question="自家歯牙移植の費用はどのくらいかかりますか？">費用について</span>
            <span class="tag tag-risk" data-question="自家歯牙移植にはどのようなリスクがありますか？">リスク</span>
            <span class="tag tag-procedure" data-question="手術はどのような流れで行われますか？">手術の流れ</span>
        </div>
    </div>   

    <!-- 基本的なQ&A -->
    <section class="qa-section">
        <div class="qa-header">
            <h2>基本的な質問</h2>
        </div>
        
        <div class="qa-item">
            <div class="qa-question">自家歯牙移植とは何ですか？</div>
            <div class="qa-answer">
                自家歯牙移植は、患者自身の口腔内から健康な歯を取り出し、別の部位に移植する治療法です。この方法は、特にインプラントや義歯、ブリッジに比べて審美性や機能性の回復が期待できる場合があります。移植に適したドナー歯がある場合、天然歯特有の利点を活かし、早期に審美性と機能性を回復することが可能です。
            </div>
        </div>

        <div class="qa-item">
            <div class="qa-question">移植と再植の違いは何ですか？</div>
            <div class="qa-answer">
                <p><strong>再植</strong>: 外傷や事故で抜けた歯を元の場所に戻す処置、または意図的に抜歯した歯を同じ場所に戻す手法です。</p>
                <p><strong>移植</strong>: 別の部位の歯を、失った歯の場所に移す処置です。例えば、親知らずを抜いて、それを別の場所に移植することがあります。</p>
            </div>
        </div>

        <div class="qa-item">
            <div class="qa-question">どのような場合に自家歯牙移植が適用されますか？</div>
            <div class="qa-answer">
                自家歯牙移植が適用される条件として、移植する歯と受容部の骨の幅が適切に合っていることが重要です。移植歯の歯根形態が円錐形で単純であることが望ましく、抜歯と同時に移植を行うことで治癒が早まります。一般的に、若年者（40歳以下）が望ましく、特に歯根が未完成の歯の移植は有用とされています。
            </div>
        </div>
    </section>

    <!-- 治療について -->
    <section class="qa-section">
        <div class="qa-header">
            <h2>治療について</h2>
        </div>
        
        <div class="qa-item">
            <div class="qa-question">移植に使える歯はどのような歯ですか？</div>
            <div class="qa-answer">
                移植に使える歯は、機能に参加していない歯で、根形態が適正であるものが適しています。理想的な歯根の形態は、凹凸が少ないやや先細りの単根歯です。歯頸部より根尖部が太い歯や、歯根が分岐している歯、根尖が湾曲している歯は適応しにくいとされています。
            </div>
        </div>

        <div class="qa-item">
            <div class="qa-question">移植後3か月の時点で部分的なアンキローシスの兆候が認められた場合、その後の長期予後をどのように予測し、患者にどのような説明とフォローアップ計画を立てるべきですか？</div>
            <div class="qa-answer">
                移植後3か月の時点で部分的なアンキローシスの兆候が認められた場合、以下のような長期予後、患者への説明、フォローアップ計画が考えられます。<br>

                <b>長期予後</b><br>
                ・アンキローシスの進行: 部分的なアンキローシスが進行する可能性がありますが、成人の場合は進行が緩慢であることが多いです。歯が長期間機能し続けることが可能です。<br>
                ・置換性吸収のリスク: アンキローシスが進行すると、置換性吸収が生じる可能性があります。これは歯根が骨に置き換わる現象で、進行が続くと歯の喪失につながることがあります。<br>
                <b>患者への説明</b><br>
                ・現状の説明: 現在、部分的なアンキローシスが認められていますが、進行は緩やかである可能性が高いことを説明します。<br>
                ・リスクの説明: 将来的に置換性吸収が進行するリスクがあることを伝え、定期的な観察が重要であることを強調します。<br>
                ・治療の選択肢: 現時点での積極的な治療は必要ないかもしれませんが、進行が見られた場合の治療オプション（例えば、インプラントなど）についても説明します。<br>
                <b>フォローアップ計画</b><br>
                ・定期的なX線検査: 進行の有無を確認するために、定期的なX線検査を行います。通常、半年から1年ごとに検査を行うことが推奨されます。<br>
                ・臨床的評価: 歯の動揺や打診音の変化を定期的に評価し、アンキローシスの進行をモニタリングします。<br>
                ・患者の協力: 患者に対して、口腔衛生の維持や定期的な歯科受診の重要性を説明し、協力を求めます。<br>
                このように、部分的なアンキローシスが認められた場合でも、適切なフォローアップと患者教育により、長期的な歯の機能維持が可能となることがあります。<br>
            </div>
        </div>

        <div class="qa-item">
            <div class="qa-question">成功率はどの程度ですか？</div>
            <div class="qa-answer">
                移植の成功率は条件によって異なります：
                <ul>
                    <li><strong>抜歯窩への移植</strong>: 95%</li>
                    <li><strong>非抜歯窩への移植</strong>: 60%</li>
                    <li><strong>39歳以下の非抜歯窩移植</strong>: 75%</li>
                    <li><strong>40歳以上の非抜歯窩移植</strong>: 49%</li>
                </ul>
                年齢や受容側の条件が成功率に大きく影響します。
            </div>
        </div>

        <div class="qa-item">
            <div class="qa-question">移植後の注意点は何ですか？</div>
            <div class="qa-answer">
                移植後は以下の点に注意が必要です：
                <ul>
                    <li>固定は強固すぎないようにし、適切な時期に根管治療を開始</li>
                    <li>術後1週間はブラッシングを禁止し、抜糸後にソフトな歯ブラシを使用</li>
                    <li>硬い食物を避け、定期的な経過観察を実施</li>
                    <li>移植後3週間目から根管治療を開始</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- 比較・選択について -->
    <section class="qa-section">
        <div class="qa-header">
            <h2>他の治療法との比較</h2>
        </div>
        
        <div class="qa-item">
            <div class="qa-question">インプラントと比較した場合のメリット・デメリットは？</div>
            <div class="qa-answer">
                <table class="comparison-table">
                    <tr>
                        <th></th>
                        <th>自家歯牙移植</th>
                        <th>インプラント</th>
                    </tr>
                    <tr>
                        <td><strong>材料</strong></td>
                        <td>自分の歯を使用</td>
                        <td>人工物（チタンなど）</td>
                    </tr>
                    <tr>
                        <td><strong>感覚</strong></td>
                        <td>自然な咬合感覚</td>
                        <td>異物感を感じることがある</td>
                    </tr>
                    <tr>
                        <td><strong>矯正治療</strong></td>
                        <td>移動可能</td>
                        <td>移動不可</td>
                    </tr>
                    <tr>
                        <td><strong>費用</strong></td>
                        <td>比較的安価</td>
                        <td>高額</td>
                    </tr>
                    <tr>
                        <td><strong>適用</strong></td>
                        <td>ドナー歯が必要</td>
                        <td>広範囲に適用可能</td>
                    </tr>
                </table>
            </div>
        </div>
    </section>

    <!-- 最新のQ&A（動的に更新される部分） -->
    <section class="latest-qa-section">
        <h2>最新の質問と回答</h2>
        <p class="text-muted">AI「raiden」に実際に寄せられた最新の質問をご紹介します</p>

        <div class="latest-qa-item">
            <div class="qa-date">2025年8月20日</div>
            <div class="qa-question">ヘルトヴィッヒの上皮鞘は移植後の治癒にどのような役割を果たしますか？</div>
            <div class="qa-answer">
                ヘルトヴィッヒの上皮鞘は、移植後の治癒において重要な役割を果たします。具体的には、以下のような役割があります。<br>
                <b>1. 歯髄の治癒と再血管化:</b> ヘルトヴィッヒの上皮鞘は、歯髄腔への毛細血管の再生を助けるバリアとして機能し、移植後の歯髄の再血管化を促進します。<br>
                <b>2. 歯根発育のポテンシャル:</b> 移植直後の歯は虚血状態に陥りますが、ヘルトヴィッヒの上皮鞘が付着していることで、歯根発育のポテンシャルが維持されます。<br>
                <b>3. 内側性の歯根膜の形成:</b> ヘルトヴィッヒの上皮鞘が壊死または除去されると、歯髄腔内に歯根膜および骨組織が侵入・再生し、内側性の歯根膜が形成されることがあります。これは正常な機能を営むと考えられます。<br>
                このように、ヘルトヴィッヒの上皮鞘は移植後の歯の治癒において、歯髄の再生や歯根の発育に寄与する重要な役割を果たしています。
                
            </div>
        </div>

        <div class="latest-qa-item">
            <div class="qa-date">2025年8月18日</div>
            <div class="qa-question">破骨細胞による骨吸収はどのような仕組みで行われますか？波状縁の役割も含めて説明してください。</div>
            <div class="qa-answer">
                破骨細胞による骨吸収の仕組みは、以下のように進行します。<br>
            1. 破骨細胞の形成: 破骨細胞は、骨髄幹細胞から分化した単球系細胞（破骨細胞前駆体）が化学走化性によって血管外に遊出し、融合・分化して多核の破骨細胞となります。<br>
            2. 骨吸収の実行: 成熟した破骨細胞は、骨表面に付着し、特殊な構造を形成します。この構造の一部が「波状縁（ruffled border）」と呼ばれます。<br>
            3. 波状縁の役割: 波状縁は、破骨細胞が骨に接する部分で、複雑に折りたたまれた膜構造を持っています。この部分から酸とリソソーム酵素が分泌されます。酸は骨の無機成分（主にカルシウム）を溶解し、リソソーム酵素は有機成分（主にコラーゲン）を分解します。<br>
            4. 吸収窩の形成: これらの作用により、骨組織に「吸収窩」と呼ばれるくぼみが形成され、骨の吸収が進行します。<br>
            このように、波状縁は破骨細胞が骨を吸収する際に重要な役割を果たし、骨の脱灰と有機質の分解を効率的に行うための構造です。<br>
                
            </div>
        </div>        
        
        <div class="latest-qa-item">
            <div class="qa-date">2025年8月17日</div>
            <div class="qa-question">上顎前歯の自家移植は可能ですか？</div>
            <div class="qa-answer">
                上顎前歯の自家歯牙移植は可能です。いくつかの症例が示されており、以下にその概要を説明します。<br>

               <b> 症例1: 第二小臼歯の前歯部への移植</b><br>
                21歳の男性で、上顎中切歯が外傷で喪失したケースです。下顎右側の過剰埋伏小臼歯をドナーとして移植し、天然歯特有の審美性と機能性の回復が期待されました。<br>
                <b> 症例2: 転位傾斜萌出小臼歯の前歯部への移植</b><br>
                50歳の男性で、歯根破折により抜歯が必要となったケースです。転位傾斜萌出した歯をドナーとして移植し、唇側の歯槽骨が再生し、歯冠修復が行われました。<br>
                <b> 矯正治療における自家歯牙移植</b><br>
                外傷により上顎前歯を喪失した患者に対して、下顎小臼歯を上顎に移植することで、審美性と機能性の回復を図るケースがあります。移植後の矯正治療により、歯の位置や形態を調整します。<br>
                これらの症例では、ドナー歯の選択や移植後の治療計画が重要であり、特に審美性の回復が求められる上顎前歯の移植では、慎重な計画と技術が必要です。<br>
                
            </div>
        </div>

        <div class="latest-qa-item">
            <div class="qa-date">2025年8月16日</div>
            <div class="qa-question">3Dレプリカを使用する理由は？</div>
            <div class="qa-answer">
                3Dレプリカを使用することで、移植前に移植床を正確に形成でき、移植歯の抜歯後短時間で適切に植立できます。これにより歯根膜へのダメージを最小限に抑え、成功率を大幅に向上させることができます。
            </div>
        </div>
        <div class="latest-qa-item">
            <div class="qa-date">2025年8月10日</div>
            <div class="qa-question">炎症性吸収の治癒には何種類のパターンがありますか？それぞれの名称を教えてください</div>
            <div class="qa-answer">
                炎症性吸収の治癒には2つのパターンがあります。<br>
            <b>1. 新付着による理想的治癒:</b><br>
            * 根管治療により感染源である壊死した歯髄組織を除去し、適切な根管充填を行うことで炎症反応が沈静化します。<br>
            * 吸収窩が歯根膜由来の細胞により修復される場合、新付着による治癒が生じます。<br>
            * この過程では、線維芽細胞、セメント芽細胞、骨芽細胞などが増殖・分化し、新たなセメント質が形成され、歯根膜線維が付着し、周囲に新しい歯槽骨が形成されます。<br>
            * 結果として、歯根と歯槽骨の間に正常な歯根膜腔が再構築され、歯の生理的可動性と正常な咬合機能が回復します。<br>
            <b>2. アンキローシスによる治癒:</b><br>
            * 吸収窩が骨組織により直接修復される場合、アンキローシス（骨性癒着）が生じます。<br>
            * 歯根膜の再生が不完全または不可能な状況で、骨芽細胞が直接歯根表面に骨組織を形成します。<br>
            * その結果、歯根と歯槽骨が歯根膜を介さずに直接的に結合した状態となります。<br>
            * アンキローシスが生じた歯では、正常な歯根膜腔は消失し、歯の生理的可動性も失われます。<br>
            どちらの治癒パターンになるかは、吸収の範囲と深さ、残存する歯根膜組織の量と活性、治療介入のタイミング、患者の年齢と治癒能力、局所の血液供給状態などの因子に影響されます。<br>
            </div>
        </div>     
        <div class="latest-qa-item">
            <div class="qa-date">2025年7月25日</div>
            <div class="qa-question">歯髄治癒と歯根発育を両立させるための最適な移植時期はいつですか？</div>
            <div class="qa-answer">
                歯髄治癒と歯根発育を両立させるための最適な移植時期は、歯根が3/4〜4/5完成した段階（Stage4〜Stage5）とされています。この段階での移植が、歯髄治癒と歯根発育のバランスを兼ね備えた最適なドナー歯となると考えられています。Stage6以降では歯髄治癒率が急激に低下することが報告されています。                
            </div>
        </div>    
    </section>

    <!-- フッター -->
    <div class="raiden-link">
        <h4>🤖 個別のご質問について</h4>
        <p>上記にない質問や、より詳しい相談については、自家歯牙移植専門AI「raiden」をご利用ください。</p>
        <a href="/dental-consultation/" class="btn btn-primary">AI相談で質問する</a>
    </div>
</div>

<!-- raiden連携機能のJavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const questionInput = document.getElementById('raiden-question');
    const askButton = document.getElementById('ask-raiden');
    const responseDiv = document.getElementById('raiden-response');
    const responseText = document.getElementById('response-text');
    const saveQAButton = document.getElementById('save-qa');

    // raidenに質問を送信する関数
    async function askRaiden(question) {
        try {
            // ローディング表示
            askButton.disabled = true;
            askButton.textContent = '回答生成中...';
            
            const response = await fetch('https://raiden.shibuya8020.com/api/question', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ question: question })
            });

            const data = await response.json();

            if (data.success) {
                // 回答を表示
                responseText.innerHTML = formatResponse(data.answer);
                responseDiv.style.display = 'block';
                
                // 回答をスムーズにスクロール
                responseDiv.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
                
                return data.answer;
            } else {
                throw new Error(data.error || '不明なエラーが発生しました');
            }

        } catch (error) {
            console.error('Error:', error);
            
            // エラーメッセージを表示
            responseText.innerHTML = `
                <div class="alert alert-danger">
                    <strong>エラー:</strong> ${error.message}
                    <br><small>raidenサーバーが起動しているか確認してください。</small>
                </div>
            `;
            responseDiv.style.display = 'block';
            
        } finally {
            // ボタンの状態を復元
            askButton.disabled = false;
            askButton.textContent = 'raidenに質問する';
        }
    }

    // 回答をHTML形式でフォーマットする関数
    function formatResponse(response) {
        // Markdownライクなフォーマットを簡単なHTMLに変換
        let formatted = response
            // **太字** を <strong> に変換
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // 改行を <br> に変換
            .replace(/\n/g, '<br>')
            // リスト項目（- で始まる行）を整理
            .replace(/^- (.+)/gm, '• $1')
            // 数字付きリスト
            .replace(/^\d+\. (.+)/gm, '<div style="margin-left: 20px;">$&</div>');
        
        return `<div class="response-content">${formatted}</div>`;
    }

    // 質問ボタンのクリックイベント
    askButton.addEventListener('click', async function() {
        const question = questionInput.value.trim();
        
        if (!question) {
            alert('質問を入力してください。');
            return;
        }

        await askRaiden(question);
    });

    // Enterキーでの送信（Shift+Enterは改行）
    questionInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            askButton.click();
        }
    });

    // Q&Aに追加するボタンのイベント
    saveQAButton.addEventListener('click', function() {
        const question = questionInput.value.trim();
        const answer = responseText.textContent || responseText.innerText;
        
        if (question && answer) {
            // ここで既存のQ&Aシステムに保存する処理を追加
            // 例：データベースへの保存、管理画面への送信など
            saveToQASystem(question, answer);
        }
    });

    // Q&Aシステムへの保存（実装に応じてカスタマイズ）
    function saveToQASystem(question, answer) {
        // 例：管理者用のAPIエンドポイントに送信
        fetch('/admin/api/save-qa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question: question,
                answer: answer,
                source: 'raiden',
                timestamp: new Date().toISOString()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Q&Aに追加されました！');
            } else {
                alert('保存に失敗しました。');
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            alert('保存中にエラーが発生しました。');
        });
    }

    // raidenの稼働状況をチェックする関数
    async function checkRaidenStatus() {
        try {
            const response = await fetch('https://raiden.shibuya8020.com/api/health');
            const data = await response.json();
            
            if (data.status === 'healthy') {
                console.log('Raiden is running properly');
                return true;
            }
        } catch (error) {
            console.warn('Raiden health check failed:', error);
            return false;
        }
    }

    // 初期化時にraidenの状態をチェック
    checkRaidenStatus().then(isHealthy => {
        if (!isHealthy) {
            // raidenが起動していない場合の警告表示
            const warningDiv = document.createElement('div');
            warningDiv.className = 'alert alert-warning';
            warningDiv.innerHTML = `
                <strong>注意:</strong> raidenサーバーに接続できません。
                <br><small>サーバーが起動していることを確認してください。</small>
            `;
            document.querySelector('.search-box').insertBefore(warningDiv, document.querySelector('.qa-input-container'));
        }
    });
});
</script>

{% endblock %}