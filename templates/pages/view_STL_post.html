{% extends "common/base.html" %}

{# SEOæœ€é©åŒ– #}
{% block title %}{{ (post.content[:50] + "...") if post.content|length > 50 else post.content }} | STLãƒ•ã‚¡ã‚¤ãƒ«æŠ•ç¨¿ï½œæ¸‹è°·æ­¯ç§‘æŠ€å·¥æ‰€{% endblock %}
{% block description %}{{ post.author.display_name }}ã«ã‚ˆã‚‹3Dãƒ¢ãƒ‡ãƒ«STLãƒ•ã‚¡ã‚¤ãƒ«ã®æŠ•ç¨¿ã€‚{{ (post.content[:100] + "...") if post.content and post.content|length > 100 else (post.content or "3Dãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°ã‚’ã”ç¢ºèªãã ã•ã„") }}{% endblock %}
{% block keywords %}STLãƒ•ã‚¡ã‚¤ãƒ«,3Dãƒ¢ãƒ‡ãƒ«,{{ post.author.display_name }},æ­¯ç§‘æŠ€å·¥,3Dãƒ—ãƒªãƒ³ãƒˆ,ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰,ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ‡ãƒ³ãƒ†ã‚£ã‚¹ãƒˆãƒªãƒ¼{% endblock %}

{% block og_type %}article{% endblock %}
{% block og_description %}{{ post.author.display_name }}ã«ã‚ˆã‚‹3Dãƒ¢ãƒ‡ãƒ«STLãƒ•ã‚¡ã‚¤ãƒ«ã®æŠ•ç¨¿ã€‚{% if post.s3_presigned_url %}3Dãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ç¢ºèªå¯èƒ½ã€‚{% endif %}{% endblock %}

{% block extra_meta %}
  {# Twitter Cardå°‚ç”¨è¨­å®š #}
  <meta name="twitter:title" content="{{ (post.content[:40] + '...') if post.content|length > 40 else post.content }} | STLæŠ•ç¨¿">
  <meta name="twitter:description" content="{{ post.author.display_name }}ã«ã‚ˆã‚‹3Dãƒ¢ãƒ‡ãƒ«STLãƒ•ã‚¡ã‚¤ãƒ«ã®æŠ•ç¨¿ã§ã™ã€‚">

  {# ãƒ‘ãƒ³ããšæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ #}
  <script type="application/ld+json">
  {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
          {
              "@type": "ListItem",
              "position": 1,
              "name": "ãƒ›ãƒ¼ãƒ ",
              "item": "https://shibuya8020.com/"
          },
          {
              "@type": "ListItem",
              "position": 2,
              "name": "STLãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ãƒœãƒ¼ãƒ‰",
              "item": "https://shibuya8020.com/stl_board/"
          },
          {
              "@type": "ListItem",
              "position": 3,
              "name": "æŠ•ç¨¿è©³ç´°",
              "item": "{{ request.url }}"
          }
      ]
  }
  </script>

  {# æŠ•ç¨¿è¨˜äº‹ã®æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ #}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SocialMediaPosting",
    "headline": "{{ post.content[:100] if post.content else '3Dãƒ¢ãƒ‡ãƒ«æŠ•ç¨¿' }}",
    "text": "{{ post.content or '3Dãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®æŠ•ç¨¿' }}",
    "url": "{{ request.url }}",
    "datePublished": "{{ post.created_at.isoformat() }}",
    "author": {
      "@type": "Person",
      "name": "{{ post.author.display_name }}"
    },
    "publisher": {
      "@type": "Organization",
      "name": "æ¸‹è°·æ­¯ç§‘æŠ€å·¥æ‰€"
    },
    "interactionStatistic": {
      "@type": "InteractionCounter",
      "interactionType": "https://schema.org/LikeAction",
      "userInteractionCount": {{ post.likes.count() }}
    },
    "commentCount": {{ comments|length }},
    {% if post.s3_presigned_url %}
    "associatedMedia": {
      "@type": "3DModel",
      "contentUrl": "{{ post.s3_presigned_url }}",
      "encodingFormat": "model/stl"
    },
    {% endif %}
    "isPartOf": {
      "@type": "WebPage",
      "name": "STLãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ãƒœãƒ¼ãƒ‰",
      "url": "https://shibuya8020.com/stl_board/"
    }
  }
  </script>

  {# ã‚³ãƒ¡ãƒ³ãƒˆç”¨ã®æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ #}
  {% if comments %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CommentAction",
    "target": "{{ request.url }}",
    "object": [
      {% for comment in comments %}
      {
        "@type": "Comment",
        "text": "{{ comment.content }}",
        "dateCreated": "{{ comment.created_at.isoformat() }}",
        "author": {
          "@type": "Person",
          "name": "{{ comment.author.display_name }}"
        }
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ]
  }
  </script>
  {% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="timeline-container">
    <div class="post-item">
      <!-- æŠ•ç¨¿ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="post-header">
        <strong>{{ post.author.display_name }}</strong>
        <span>{{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
      </div>
      
      <!-- æŠ•ç¨¿æœ¬æ–‡ -->
      <div class="post-body">
        {{ post.content or "ï¼ˆæœ¬æ–‡ãªã—ï¼‰" }}
      </div>
      
      <!-- ãƒ¢ãƒ‡ãƒ«ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ -->
      {% if post.s3_presigned_url %}
      <div class="model-viewer-container">
        <model-viewer src="{{ post.s3_presigned_url }}"
                      auto-rotate
                      camera-controls
                      style="width: 100%; height: 400px; background-color: #fff;">
        </model-viewer>
      </div>
      {% endif %}
      
      <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="post-actions">
        <form method="POST" action="{{ url_for('stl_board.like_post', post_id=post.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit">â¤ï¸ {{ post.likes.count() }}</button>
        </form>
        <a href="#comments">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ</a>
        <button onclick="copyToClipboard(window.location.href)">ğŸ“‹ URLã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
      
      <!-- ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <h5 class="mt-4" id="comments">ã‚³ãƒ¡ãƒ³ãƒˆ</h5>
      {% for comment in comments %}
        {% if not comment.parent_comment_id %}
        <div class="comment-item">
          <div class="comment-header">
            {{ comment.author.display_name }} ãƒ» {{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}
          </div>
          <div>{{ comment.content }}</div>
        </div>
        {% endif %}
      {% endfor %}
      
      <!-- ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
      {% if current_user.is_authenticated %}
      <form method="POST" action="{{ url_for('stl_board.add_comment', post_id=post.id) }}"
            class="comment-form mt-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <textarea name="content" rows="2" required placeholder="è¿”ä¿¡ã‚’å…¥åŠ›â€¦"></textarea>
        <button class="btn btn-sm btn-outline-primary" type="submit">è¿”ä¿¡ã™ã‚‹</button>
      </form>
      {% endif %}
    </div>
  </div>
  
  <div class="mt-4">
    <a href="{{ url_for('stl_board.index') }}" class="btn btn-outline-secondary">â† ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«æˆ»ã‚‹</a>
  </div>
</div>

<script>
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  }, function() {
    alert('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸ');
  });
}
</script>
{% endblock %}