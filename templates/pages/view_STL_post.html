{% extends "common/base.html" %}

{# SEO最適化 #}
{% block title %}{{ (post.content[:50] + "...") if post.content|length > 50 else post.content }} | STLファイル投稿｜渋谷歯科技工所{% endblock %}
{% block description %}{{ post.author.display_name }}による3DモデルSTLファイルの投稿。{{ (post.content[:100] + "...") if post.content and post.content|length > 100 else (post.content or "3Dモデルファイルの詳細をご確認ください") }}{% endblock %}
{% block keywords %}STLファイル,3Dモデル,{{ post.author.display_name }},歯科技工,3Dプリント,ファイル共有,デジタルデンティストリー{% endblock %}

{% block og_type %}article{% endblock %}
{% block og_description %}{{ post.author.display_name }}による3DモデルSTLファイルの投稿。{% if post.s3_presigned_url %}3Dビューアーで確認可能。{% endif %}{% endblock %}

{% block extra_meta %}
  {# Twitter Card専用設定 #}
  <meta name="twitter:title" content="{{ (post.content[:40] + '...') if post.content|length > 40 else post.content }} | STL投稿">
  <meta name="twitter:description" content="{{ post.author.display_name }}による3DモデルSTLファイルの投稿です。">

  {# パンくず構造化データ #}
  <script type="application/ld+json">
  {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
          {
              "@type": "ListItem",
              "position": 1,
              "name": "ホーム",
              "item": "https://shibuya8020.com/"
          },
          {
              "@type": "ListItem",
              "position": 2,
              "name": "STLファイル共有ボード",
              "item": "https://shibuya8020.com/stl_board/"
          },
          {
              "@type": "ListItem",
              "position": 3,
              "name": "投稿詳細",
              "item": "{{ request.url }}"
          }
      ]
  }
  </script>

  {# 投稿記事の構造化データ #}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SocialMediaPosting",
    "headline": "{{ post.content[:100] if post.content else '3Dモデル投稿' }}",
    "text": "{{ post.content or '3Dモデルファイルの投稿' }}",
    "url": "{{ request.url }}",
    "datePublished": "{{ post.created_at.isoformat() }}",
    "author": {
      "@type": "Person",
      "name": "{{ post.author.display_name }}"
    },
    "publisher": {
      "@type": "Organization",
      "name": "渋谷歯科技工所"
    },
    "interactionStatistic": {
      "@type": "InteractionCounter",
      "interactionType": "https://schema.org/LikeAction",
      "userInteractionCount": {{ post.likes.count() }}
    },
    "commentCount": {{ comments|length }},
    {% if post.s3_presigned_url %}
    "associatedMedia": {
      "@type": "3DModel",
      "contentUrl": "{{ post.s3_presigned_url }}",
      "encodingFormat": "model/stl"
    },
    {% endif %}
    "isPartOf": {
      "@type": "WebPage",
      "name": "STLファイル共有ボード",
      "url": "https://shibuya8020.com/stl_board/"
    }
  }
  </script>

  {# コメント用の構造化データ #}
  {% if comments %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CommentAction",
    "target": "{{ request.url }}",
    "object": [
      {% for comment in comments %}
      {
        "@type": "Comment",
        "text": "{{ comment.content }}",
        "dateCreated": "{{ comment.created_at.isoformat() }}",
        "author": {
          "@type": "Person",
          "name": "{{ comment.author.display_name }}"
        }
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ]
  }
  </script>
  {% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="timeline-container">
    <div class="post-item">
      <!-- 投稿ヘッダー -->
      <div class="post-header">
        <strong>{{ post.author.display_name }}</strong>
        <span>{{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
      </div>
      
      <!-- 投稿本文 -->
      <div class="post-body">
        {{ post.content or "（本文なし）" }}
      </div>
      
      <!-- モデルビューアー -->
      {% if post.s3_presigned_url %}
      <div class="model-viewer-container">
        <model-viewer src="{{ post.s3_presigned_url }}"
                      auto-rotate
                      camera-controls
                      style="width: 100%; height: 400px; background-color: #fff;">
        </model-viewer>
      </div>
      {% endif %}
      
      <!-- アクション -->
      <div class="post-actions">
        <form method="POST" action="{{ url_for('stl_board.like_post', post_id=post.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit">❤️ {{ post.likes.count() }}</button>
        </form>
        <a href="#comments">💬 コメント</a>
        <button onclick="copyToClipboard(window.location.href)">📋 URLをコピー</button>
      </div>
      
      <!-- コメントセクション -->
      <h5 class="mt-4" id="comments">コメント</h5>
      {% for comment in comments %}
        {% if not comment.parent_comment_id %}
        <div class="comment-item">
          <div class="comment-header">
            {{ comment.author.display_name }} ・ {{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}
          </div>
          <div>{{ comment.content }}</div>
        </div>
        {% endif %}
      {% endfor %}
      
      <!-- コメント投稿フォーム -->
      {% if current_user.is_authenticated %}
      <form method="POST" action="{{ url_for('stl_board.add_comment', post_id=post.id) }}"
            class="comment-form mt-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <textarea name="content" rows="2" required placeholder="返信を入力…"></textarea>
        <button class="btn btn-sm btn-outline-primary" type="submit">返信する</button>
      </form>
      {% endif %}
    </div>
  </div>
  
  <div class="mt-4">
    <a href="{{ url_for('stl_board.index') }}" class="btn btn-outline-secondary">← タイムラインに戻る</a>
  </div>
</div>

<script>
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    alert('URLをコピーしました');
  }, function() {
    alert('コピーできませんでした');
  });
}
</script>
{% endblock %}