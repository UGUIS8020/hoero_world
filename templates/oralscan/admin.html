{% extends "common/base.html" %}

{% block title %}Oral Scan è‡ªå‹•åŒ–ç®¡ç†{% endblock %}

{% block extra_css %}
<style>
    .oralscan-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
    }
    
    .oralscan-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .oralscan-header h1 {
        margin: 0;
        font-size: 28px;
    }
    
    .oralscan-header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
    }
    
    .card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .card h2 {
        margin-bottom: 20px;
        color: #333;
        font-size: 20px;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
    }
    
    .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .status-item {
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }
    
    .status-item label {
        display: block;
        color: #666;
        font-size: 13px;
        margin-bottom: 8px;
        font-weight: 500;
    }
    
    .status-item .value {
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }
    
    .status-running {
        border-left-color: #f39c12;
    }
    
    .status-success {
        border-left-color: #27ae60;
    }
    
    .status-failed {
        border-left-color: #e74c3c;
    }
    
    .run-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .run-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .run-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }
    
    .alert.success {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
        display: block;
    }
    
    .alert.error {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
        display: block;
    }
    
    .alert.info {
        background-color: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
        display: block;
    }
    
    .spinner {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        vertical-align: middle;
        margin-right: 8px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .instructions {
        background: #e8f4f8;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #3498db;
    }
    
    .instructions h3 {
        color: #2980b9;
        margin-bottom: 12px;
        font-size: 16px;
    }
    
    .instructions ul {
        margin-left: 20px;
        color: #555;
    }
    
    .instructions li {
        margin-bottom: 8px;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .badge-success {
        background: #d4edda;
        color: #155724;
    }
    
    .badge-danger {
        background: #f8d7da;
        color: #721c24;
    }
    
    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }
</style>
{% endblock %}

{% block content %}
<div class="oralscan-container">   
    
    <div class="card">
        <h2>ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
        <div class="status-grid">
            <div class="status-item" id="status-running">
                <label>å®Ÿè¡ŒçŠ¶æ…‹</label>
                <div class="value" id="running-status">
                    {% if status.is_running %}
                        <span style="color: #f39c12;">â³ å®Ÿè¡Œä¸­</span>
                    {% else %}
                        <span style="color: #27ae60;">âœ“ å¾…æ©Ÿä¸­</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="status-item">
                <label>æœ€çµ‚å®Ÿè¡Œæ—¥æ™‚</label>
                <div class="value" id="last-run">
                    {{ status.last_run or 'æœªå®Ÿè¡Œ' }}
                </div>
            </div>
            
            <div class="status-item {% if status.last_result == 'success' %}status-success{% elif status.last_result == 'failed' %}status-failed{% endif %}">
                <label>æœ€çµ‚å®Ÿè¡Œçµæœ</label>
                <div class="value" id="last-result">
                    {% if status.last_result == 'success' %}
                        <span class="badge badge-success">âœ… æˆåŠŸ</span>
                    {% elif status.last_result == 'failed' %}
                        <span class="badge badge-danger">âŒ å¤±æ•—</span>
                    {% elif status.last_result == 'error' %}
                        <span class="badge badge-warning">âš ï¸ ã‚¨ãƒ©ãƒ¼</span>
                    {% else %}
                        <span>-</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div id="message-box"></div>
    </div>
    
    <div class="card">
        <h2>ğŸš€ å®Ÿè¡Œ</h2>
        <button type="button" class="run-btn" id="run-bot-btn">
            Oral Scan ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ç—‡ä¾‹ä¸€è¦§ã‚’é–‹ã
        </button>
    </div>
    
    <div class="card instructions">
        <h3>ğŸ“‹ ä½¿ç”¨æ–¹æ³•</h3>
        <ul>
            <li>ä¸Šè¨˜ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€Oral Scan Dataã«è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™</li>
            <li>ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€è‡ªå‹•çš„ã«ç—‡ä¾‹ä¸€è¦§ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™</li>
            <li>å‡¦ç†ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ï¼‰</li>
            <li>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯è‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã™</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}

<script>
(function() {
  'use strict';
  
  let pollTimer = null;
  let pollMs = 0;

  function showMessage(message, type) {
    const box = document.getElementById('message-box');
    if (!box) return;
    box.className = 'alert ' + type;
    box.textContent = message;
    box.style.display = 'block';
  }

  function startPolling(ms) {
    if (pollMs === ms && pollTimer) return;
    if (pollTimer) clearInterval(pollTimer);
    pollMs = ms;
    pollTimer = setInterval(updateStatus, ms);
  }

  async function updateStatus() {
    try {
      const res = await fetch('{{ url_for("oralscan.get_status") }}', {
        credentials: 'same-origin'
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      const runningStatus = document.getElementById('running-status');
      const runBtn = document.getElementById('run-bot-btn');

      if (data.is_running) {
        if (runningStatus) {
          runningStatus.innerHTML =
            '<span style="color:#f39c12;"><span class="spinner"></span> å®Ÿè¡Œä¸­</span>';
        }
        if (runBtn) {
          runBtn.disabled = true;
          runBtn.innerHTML = '<span class="spinner"></span> å®Ÿè¡Œä¸­...';
        }
        startPolling(2000);
      } else {
        if (runningStatus) {
          runningStatus.innerHTML = '<span style="color:#27ae60;">âœ“ å¾…æ©Ÿä¸­</span>';
        }
        if (runBtn) {
          runBtn.disabled = false;
          runBtn.textContent = 'Oral Scan ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ç—‡ä¾‹ä¸€è¦§ã‚’é–‹ã';
        }
        startPolling(5000);
      }

      if (data.last_run) {
        const lastRun = document.getElementById('last-run');
        if (lastRun) lastRun.textContent = data.last_run;
      }

      const lastResultElem = document.getElementById('last-result');
      if (lastResultElem) {
        if (data.last_result === 'success') {
          lastResultElem.innerHTML = '<span class="badge badge-success">âœ… æˆåŠŸ</span>';
        } else if (data.last_result === 'failed') {
          lastResultElem.innerHTML = '<span class="badge badge-danger">âŒ å¤±æ•—</span>';
        } else if (data.last_result === 'error') {
          lastResultElem.innerHTML = '<span class="badge badge-warning">âš ï¸ ã‚¨ãƒ©ãƒ¼</span>';
        }
      }

      if (data.message && !data.is_running) {
        showMessage(data.message, data.last_result === 'success' ? 'success' : 'error');
      }
    } catch (err) {
      console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    }
  }

  async function runBot() {
  const btn = document.getElementById('run-bot-btn');
  if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> å®Ÿè¡Œä¸­...'; }
  showMessage('ãƒœãƒƒãƒˆã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...', 'info');

  try {
    const res = await fetch('{{ url_for("oralscan.run_bot") }}', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        // Flask-WTF ã‚’ä½¿ã£ã¦ã„ã‚‹ãªã‚‰æœ‰åŠ¹ã€‚æœªä½¿ç”¨ã§ã‚‚ç©ºæ–‡å­—ã§å•é¡Œãªã—
        'X-CSRFToken': '{{ csrf_token()|default("", true) }}'
      },
      // ã‚µãƒ¼ãƒãŒä½•ã‹ã‚­ãƒ¼ã‚’æœŸå¾…ã—ã¦ã„ã‚‹å ´åˆã«å‚™ãˆã¦æœ€ä½é™ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ¸¡ã™
      body: JSON.stringify({ action: 'run' })
    });

    // 400æ™‚ã®æœ¬æ–‡ã‚’æ‹¾ã£ã¦è¦‹ãˆã‚‹åŒ–
    if (!res.ok) {
      const text = await res.text();
      console.error('run-bot error body:', text);
      throw new Error(`HTTP ${res.status} ${text || ''}`.trim());
    }

    const data = await res.json();
    if (data.success) {
      showMessage(data.message || 'èµ·å‹•ã—ã¾ã—ãŸã€‚', 'success');
      startPolling(2000);
    } else {
      showMessage(data.message || 'èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
      if (btn) { btn.disabled = false; btn.textContent = 'Oral Scan ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ç—‡ä¾‹ä¸€è¦§ã‚’é–‹ã'; }
    }
  } catch (err) {
    showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err, 'error');
    if (btn) { btn.disabled = false; btn.textContent = 'Oral Scan ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ç—‡ä¾‹ä¸€è¦§ã‚’é–‹ã'; }
  } finally {
    updateStatus();
  }
}

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  function init() {
    console.log('ğŸ¯ åˆæœŸåŒ–é–‹å§‹');
    
    const btn = document.getElementById('run-bot-btn');
    console.log('ãƒœã‚¿ãƒ³è¦ç´ :', btn);
    
    if (!btn) {
      console.error('âŒ ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼');
      return;
    }
    
    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    btn.addEventListener('click', function(e) {
      console.log('ğŸ–±ï¸ ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
      e.preventDefault();
      e.stopPropagation();
      runBot();
    });
    
    console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
    
    updateStatus();
    startPolling(5000);
  }
})();
</script>

{% endblock %}